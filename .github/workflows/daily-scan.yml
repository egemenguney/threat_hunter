name: Daily Malware Scan

on:
  schedule:
    # Her gÃ¼n 06:00 UTC (09:00 TÃ¼rkiye)
    - cron: '0 6 * * *'
  
  # Manuel tetikleme
  workflow_dispatch:
    inputs:
      max_results:
        description: 'Max results per query'
        required: false
        default: '100'
      rate_limit_wait:
        description: 'Max wait time for rate limit (seconds)'
        required: false
        default: '3600'
      check_auto_remove:
        description: 'Auto-remove deleted repos from detected_repos.json (true/false)'
        required: false
        default: 'true'
      check_dry_run:
        description: 'If true, do not modify detected_repos.json (dry run)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  # Rate limit bitince kaÃ§ saniye beklesin (default: 60 dakika)
  RATE_LIMIT_MAX_WAIT: ${{ github.event.inputs.rate_limit_wait || '3600' }}

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 saat max - rate limit bekleme iÃ§in yeterli
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies installed (including DuckDuckGo search fallback)"
      
      - name: Check rate limit before scan
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
        run: |
          echo "ðŸ”‘ Checking rate limit status..."
          RATE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit)
          CORE_REMAINING=$(echo $RATE_INFO | jq '.resources.core.remaining')
          SEARCH_REMAINING=$(echo $RATE_INFO | jq '.resources.search.remaining')
          CORE_RESET=$(echo $RATE_INFO | jq '.resources.core.reset')
          
          echo "ðŸ“Š Core API remaining: $CORE_REMAINING/5000"
          echo "ðŸ” Search API remaining: $SEARCH_REMAINING/30"
          
          # EÄŸer core API 500'Ã¼n altÄ±ndaysa bekle
          if [ "$CORE_REMAINING" -lt 500 ]; then
            CURRENT_TIME=$(date +%s)
            WAIT_TIME=$((CORE_RESET - CURRENT_TIME + 60))
            if [ "$WAIT_TIME" -gt 0 ] && [ "$WAIT_TIME" -lt 3600 ]; then
              echo "â³ Low rate limit, waiting ${WAIT_TIME}s for reset..."
              sleep $WAIT_TIME
            fi
          fi
      
      - name: Test SCAN_TOKEN validity
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
        run: |
          echo "ðŸ”‘ Testing SCAN_TOKEN..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | jq '.login // "ERROR"'
          echo "âœ… Token test completed"
      
      - name: Run malware scan
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
          RATE_LIMIT_MAX_WAIT: ${{ env.RATE_LIMIT_MAX_WAIT }}
        run: |
          echo "ðŸ” Starting malware scan with SCAN_TOKEN..."
          echo "â±ï¸ Max rate limit wait: ${RATE_LIMIT_MAX_WAIT}s"
          python threat_hunter.py
      
      - name: Show final rate limit status
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
        run: |
          echo "ðŸ“Š Final rate limit status:"
          curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit | jq '.resources | {core: .core.remaining, search: .search.remaining}'
      
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            detected_repos.json
            detected_repos.csv
            AUTO_GENERATED_REPORT.md
            SUGGESTED_PATTERNS.txt
          retention-days: 30

      - name: Update `detected_repos` (remove missing repositories)
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
          AUTO_REMOVE: ${{ github.event.inputs.check_auto_remove || 'true' }}
          DRY_RUN: ${{ github.event.inputs.check_dry_run || 'false' }}
        run: |
          echo "ðŸ” Checking repositories in detected_repos..."
          echo "Auto-remove: $AUTO_REMOVE | Dry-run: $DRY_RUN"
          if [ "$DRY_RUN" = 'true' ]; then
            echo "Running in dry-run mode (no changes will be made)"
            echo n | python check_repos_status.py
          else
            if [ "$AUTO_REMOVE" = 'true' ]; then
              echo y | python check_repos_status.py
            else
              echo n | python check_repos_status.py
            fi
          fi
          echo "âœ… detected_repos check completed"

      - name: Run pipeline analysis
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
        run: |
          echo "ðŸ”¬ Running pipeline analysis..."
          python pipeline.py
          echo "âœ… Pipeline analysis completed"
          
          # Show summary
          echo "ðŸ“Š Pipeline Results:"
          cat pipeline_output/FINAL_REPORT.md | head -50

      - name: Upload pipeline results
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-results-${{ github.run_number }}
          path: |
            pipeline_output/
          retention-days: 30
      
      - name: Check for HIGH severity detections
        id: check_high
        run: |
          HIGH_COUNT=$(python -c "import json; data=json.load(open('detected_repos.json')); print(len([d for d in data if d.get('severity')=='HIGH']))")
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "Found $HIGH_COUNT HIGH severity repositories"
      
      - name: Check for new pattern suggestions
        id: check_patterns
        run: |
          if [ -f "SUGGESTED_PATTERNS.txt" ]; then
            echo "new_patterns=true" >> $GITHUB_OUTPUT
            echo "New pattern suggestions found"
          else
            echo "new_patterns=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create issue for new detections
        if: steps.check_high.outputs.high_count > 0
        uses: actions/github-script@v7
        env:
          NEW_PATTERNS: ${{ steps.check_patterns.outputs.new_patterns }}
        with:
          # SCAN_TOKEN kullan (1000 rate limit rezerve edildi)
          github-token: ${{ secrets.SCAN_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              // Rate limit kontrolÃ¼
              const rateLimit = await github.rest.rateLimit.get();
              const remaining = rateLimit.data.rate.remaining;
              
              console.log(`ðŸ“Š Rate limit remaining: ${remaining}`);
              
              if (remaining < 50) {
                throw new Error(`Rate limit too low (${remaining}), cannot create issue safely`);
              }
              
              const data = JSON.parse(fs.readFileSync('detected_repos.json', 'utf8'));
              const highSeverity = data.filter(d => d.severity === 'HIGH');
              
              if (highSeverity.length === 0) return;
              
              // Pipeline sonuÃ§larÄ±nÄ± oku
              let pipelineSummary = '';
              try {
                const pipelineReport = fs.readFileSync('pipeline_output/repos_to_report.json', 'utf8');
                const pipelineData = JSON.parse(pipelineReport);
                const critical = pipelineData.filter(r => r.severity === 'CRITICAL').length;
                const high = pipelineData.filter(r => r.severity === 'HIGH').length;
                const obfuscated = pipelineData.filter(r => r.detection_type.includes('obfuscated_js')).length;
                const easylauncher = pipelineData.filter(r => r.detection_type.includes('easylauncher')).length;
                
                pipelineSummary = `
              ### ðŸ”¬ Pipeline Analysis
              | Category | Count |
              |----------|-------|
              | CRITICAL | ${critical} |
              | HIGH | ${high} |
              | Obfuscated JS | ${obfuscated} |
              | easylauncher.su | ${easylauncher} |
              | **Total to Report** | **${pipelineData.length}** |
              `;
              } catch (e) {
                console.log('Pipeline results not found');
              }
              
              const body = `## ðŸš¨ Daily Scan Results - ${new Date().toISOString().split('T')[0]}
              
              **HIGH Severity Detections: ${highSeverity.length}**
              ${pipelineSummary}
              
              ### Top 20 Detected Repos
              | Repository | Type | Score |
              |------------|------|-------|
              ${highSeverity.slice(0, 20).map(r => `| [${r.owner}/${r.repo_name}](${r.url}) | ${r.detection_type} | ${r.suspicion_score}/100 |`).join('\n')}
              
              ${highSeverity.length > 20 ? `\n*... and ${highSeverity.length - 20} more*` : ''}
              
              ðŸ“ Full results in workflow artifacts.
              
              ${process.env.NEW_PATTERNS === 'true' ? '\nðŸ§  **New pattern suggestions found** - Check SUGGESTED_PATTERNS.txt in artifacts' : ''}
              `;
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Malware Scan: ${highSeverity.length} HIGH severity repos detected`,
                body: body,
                labels: ['malware-detection', 'automated']
              });
              
              console.log(`âœ… Issue created: #${issue.data.number}`);
              console.log(`ðŸ“Š Rate limit after issue: ${(await github.rest.rateLimit.get()).data.rate.remaining}`);
              
            } catch (error) {
              // Rate limit veya baÅŸka hata - CRITICAL: Bu adÄ±m baÅŸarÄ±sÄ±z olursa workflow fail olsun
              console.error(`âŒ CRITICAL: Failed to create issue: ${error.message}`);
              core.setFailed(`Issue creation failed: ${error.message}`);
            }
      
      - name: Commit updated detected_repos
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add detected_repos.json detected_repos.csv
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update detected repos [skip ci]"
            git push
            echo "âœ… Updated detected_repos committed"
          fi

      - name: Auto-report HIGH severity repos
        if: steps.check_high.outputs.high_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TOKEN }}
        run: |
          echo "ðŸ¤– Generating report files for HIGH severity repositories..."
          HIGH_COUNT=${{ steps.check_high.outputs.high_count }}
          
          # Generate reports for up to 50 repos per run
          MAX_REPORTS=50
          
          echo "ðŸ“Š Found $HIGH_COUNT HIGH severity repos, generating reports for up to $MAX_REPORTS"
          
          # Run mass reporter in auto mode (generates report files, not actual GitHub reports)
          python mass_reporter.py detected_repos.json --severity HIGH --max $MAX_REPORTS --auto
          
          echo "âœ… Report files generated in reports/ folder"

      - name: Upload report logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-logs-${{ github.run_number }}
          path: |
            mass_report_log.json
            mass_report_summary.md
            reports/
          retention-days: 30
          if-no-files-found: ignore

  notify:
    needs: scan
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Notify on failure
        run: |
          echo "Scan failed! Check workflow logs."

